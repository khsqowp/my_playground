name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        run: |
          Write-Host "1. Building and Starting Services..."
          # .env 파일을 최소한으로 생성 (컨테이너 내부 참조용)
          $envLines = @(
            "DATABASE_URL=postgresql://postgres:postgres@db:5432/88motorcycle",
            "NEXTAUTH_URL=http://localhost:3000",
            "AUTH_TRUST_HOST=true",
            "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}",
            "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}",
            "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}",
            "ADMIN_NAME=${{ secrets.ADMIN_NAME }}"
          )
          [System.IO.File]::WriteAllText("$pwd\.env", ($envLines -join "`n"), (New-Object System.Text.UTF8Encoding($false)))

          docker-compose down
          docker-compose up -d --build
          
          Write-Host "Waiting for database to be ready (20s)..."
          Start-Sleep -Seconds 20
          
          Write-Host "2. Syncing Database Schema (Using Official Prisma Image)..."
          # 프로젝트의 prisma/schema.prisma 파일을 공식 prisma 이미지에 마운트하여 실행 (버전/엔진 문제 완전 해결)
          docker run --rm --network my_playground_app-network `
            -v ${pwd}\prisma:/prisma `
            -e DATABASE_URL="postgresql://postgres:postgres@88motorcycle-db:5432/88motorcycle" `
            prisma/prisma:6.2.0 prisma db push --accept-data-loss --schema=/prisma/schema.prisma

          Write-Host "3. Seeding Admin Account (Direct Node Execution)..."
          # 이미 구동된 앱 컨테이너에서 node로 직접 시드 스크립트 실행
          docker exec -e ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}" -e ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" -e ADMIN_NAME="${{ secrets.ADMIN_NAME }}" `
            88motorcycle-web node prisma/seed-simple.js
          
          Write-Host "Final Status:"
          docker ps -a
