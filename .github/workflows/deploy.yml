name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        env:
          DOCKER_HOST: tcp://localhost:2375
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          Write-Host "Deploying with GitHub Secrets..."
          
          # 1. 기존 컨테이너 중지 (데이터 볼륨은 유지)
          docker-compose down
          
          # 2. 컨테이너 시작
          docker-compose up -d --build
          
          Write-Host "Waiting for services to be ready (20s)..."
          Start-Sleep -Seconds 20
          
          # 3. 데이터베이스 테이블 생성 및 시드 실행
          Write-Host "Syncing database schema..."
          docker exec 88motorcycle-web npx prisma db push --accept-data-loss
          
          Write-Host "Seeding admin account and initial data..."
          docker exec 88motorcycle-web npx prisma db seed
          
          Write-Host "Final Container Status:"
          docker ps -a
          docker ps -a
