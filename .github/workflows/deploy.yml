name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        run: |
          Write-Host "1. Generating .env file from GitHub Secrets..."
          # GitHub Secrets로부터 변수를 가져와 리눅스 호환 .env 파일 생성
          $envLines = @(
            "DATABASE_URL=postgresql://postgres:postgres@db:5432/88motorcycle",
            "NEXTAUTH_URL=http://localhost:3000",
            "AUTH_TRUST_HOST=true",
            "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}",
            "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}",
            "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}",
            "ADMIN_NAME=${{ secrets.ADMIN_NAME }}",
            "UPLOAD_MAX_SIZE_MB=100",
            "UPLOAD_DIR=./public/uploads"
          )
          # UTF-8 (BOM 없음) 및 LF(리눅스 줄바꿈)으로 저장
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText("$pwd\.env", ($envLines -join "`n"), $utf8NoBom)
          Write-Host "Successfully generated .env file."

          Write-Host "2. Deploying with Docker Compose..."
          docker-compose down
          # 1) 컨테이너 빌드 및 DB 엔진 우선 기동
          docker-compose up -d --build db
          Write-Host "Waiting for database to be ready..."
          Start-Sleep -Seconds 15
          
          # 2) 임시 컨테이너를 띄워 DB 스키마 동기화 및 시드 실행 (가장 확실한 방법)
          Write-Host "Syncing database schema & Seeding admin account..."
          # npx prisma@6를 사용하여 버전 충돌 방지
          docker-compose run --rm app npx prisma@6 db push --accept-data-loss
          docker-compose run --rm app npm run db:seed
          
          # 3) 나머지 전체 서비스 기동
          docker-compose up -d
          
          Write-Host "Final Container Status:"
          docker ps -a
