name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          Write-Host "1. Processing Master .env file..."
          $masterEnv = "C:\actions-runner\.env"
          $targetEnv = Join-Path (Get-Location) ".env"
          
          if (Test-Path $masterEnv) {
            $finalContent = @()
            $hasAuthSecret = $false
            $nextAuthSecret = ""

            # 파일 읽기 (인코딩 무관하게 읽기 위해 Raw 사용)
            Get-Content $masterEnv | ForEach-Object {
              $line = $_.Trim()
              if ($line -match '^([^#\s][^=]*)=(.*)$') {
                $key = $Matches[1].Trim()
                $val = $Matches[2].Trim().Trim('"').Trim("'")
                
                # DB URL 공백 제거 (사용자 오타 수정)
                if ($key -eq "DATABASE_URL") { $val = $val.Replace(" ", "") }
                
                # AUTH_SECRET 존재 확인 및 값 보관
                if ($key -eq "AUTH_SECRET") { $hasAuthSecret = $true }
                if ($key -eq "NEXTAUTH_SECRET") { $nextAuthSecret = $val }
                
                $finalContent += "$key=$val"
              } elseif ($line.StartsWith("#") -or [string]::IsNullOrWhiteSpace($line)) {
                $finalContent += $line
              }
            }

            # AUTH_SECRET이 없으면 NEXTAUTH_SECRET 값으로 추가
            if (-not $hasAuthSecret -and -not [string]::IsNullOrEmpty($nextAuthSecret)) {
              $finalContent += "AUTH_SECRET=$nextAuthSecret"
              Write-Host "Added missing AUTH_SECRET from NEXTAUTH_SECRET"
            }

            # 리눅스 호환 UTF-8 (BOM 없음) + LF 형식으로 저장
            $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
            [System.IO.File]::WriteAllText($targetEnv, ($finalContent -join "`n"), $utf8NoBom)
            Write-Host "Successfully generated clean .env file."
          } else {
            Write-Host "ERROR: Master .env not found at $masterEnv"
            exit 1
          }

          Write-Host "2. Deploying with Docker Compose..."
          docker-compose down
          # --env-file 플래그로 명시적 주입
          docker-compose --env-file .env up -d --build
          
          Write-Host "Current Container Status:"
          docker ps -a
