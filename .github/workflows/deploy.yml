name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          Write-Host "1. Preparing environment variables..."
          $masterEnv = "C:\actions-runner\.env"
          if (Test-Path $masterEnv) {
            # .env 파일을 읽어서 현재 세션의 환경 변수로 등록
            Get-Content $masterEnv | ForEach-Object {
              if ($_ -match '^(?<name>[^#\s][^=]*)=(?<value>.*)$') {
                $name = $Matches['name'].Trim()
                $value = $Matches['value'].Trim().Trim('"').Trim("'")
                [System.Environment]::SetEnvironmentVariable($name, $value)
                Write-Host "Exported: $name"
              }
            }
            # .env 파일 자체도 생성 (이미지 빌드 시 필요할 수 있음)
            Copy-Item $masterEnv .env -Force
          }

          Write-Host "2. Deploying with Docker Compose..."
          docker-compose down
          # 환경 변수가 주입된 상태에서 실행
          docker-compose up -d --build
          
          Write-Host "Current Container Status:"
          docker ps -a
