name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        run: |
          # 한글 깨짐 방지를 위한 인코딩 설정
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [System.Text.Encoding]::UTF8

          Write-Host "1. Preparing environment file..."
          $envLines = @(
            "DATABASE_URL=postgresql://postgres:postgres@db:5432/88motorcycle",
            "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}",
            "AUTH_TRUST_HOST=true",
            "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}",
            "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}",
            "GEMINI_API_KEY2=${{ secrets.GEMINI_API_KEY2 }}",
            "GEMINI_API_KEY3=${{ secrets.GEMINI_API_KEY3 }}",
            "GEMINI_API_KEY4=${{ secrets.GEMINI_API_KEY4 }}",
            "GEMINI_API_KEY5=${{ secrets.GEMINI_API_KEY5 }}",
            "GEMINI_API_KEY6=${{ secrets.GEMINI_API_KEY6 }}",
            "GEMINI_API_KEY7=${{ secrets.GEMINI_API_KEY7 }}",
            "GEMINI_API_KEY8=${{ secrets.GEMINI_API_KEY8 }}",
            "GEMINI_API_KEY9=${{ secrets.GEMINI_API_KEY9 }}",
            "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}",
            "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}",
            "ADMIN_NAME=${{ secrets.ADMIN_NAME }}",
            "SERVICE_API_KEY=${{ secrets.SERVICE_API_KEY }}",
            "DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}",
            "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN_PAT || github.token }}",
            "UPLOAD_MAX_SIZE_MB=100",
            "UPLOAD_DIR=./public/uploads"
          )
          [System.IO.File]::WriteAllText("$pwd\.env", ($envLines -join "`n"), (New-Object System.Text.UTF8Encoding($false)))

          # 재빌드 및 재시작
          docker-compose down
          docker-compose up -d --build
          
          Write-Host "2. Waiting for database (30s)..."
          Start-Sleep -Seconds 30
          
          Write-Host "3. Finalizing Database (Sync & Seed)..."
          # Prisma 6 버전을 강제하여 v7과의 충돌을 완전히 차단
          docker exec 88motorcycle-web npx prisma@6 db push --accept-data-loss
          
          # 이미 구동된 앱 컨테이너에서 비밀번호 업데이트 시도
          docker exec -e ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}" -e ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}" -e ADMIN_NAME="${{ secrets.ADMIN_NAME }}" `
            88motorcycle-web node prisma/seed-simple.js
          
          Write-Host "Deployment Complete."
          docker ps -a
