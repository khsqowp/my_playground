name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          Write-Host "Cleaning up and preparing environment..."
          # 기존 .env 파일 제거
          if (Test-Path .env) { Remove-Item .env -Force }

          # C:\actions-runner\.env를 읽어서 UTF-8로 다시 저장 (인코딩 문제 해결)
          if (Test-Path "C:\actions-runner\.env") {
            $content = Get-Content "C:\actions-runner\.env" -Raw
            # UTF-8 (BOM 없음)으로 저장
            [System.IO.File]::WriteAllText("$pwd\.env", $content, (New-Object System.Text.UTF8Encoding($false)))
            Write-Host "Successfully recreated .env in UTF-8 encoding."
          } else {
            Write-Host "ERROR: C:\actions-runner\.env not found!"
            exit 1
          }

          # 파일 이름 앞에 @가 붙은 파일들 정리
          Get-ChildItem -Path . -Filter "@.*" | ForEach-Object {
            $newName = $_.Name.Replace("@", "")
            if (-not (Test-Path $newName)) {
              Move-Item $_.FullName $newName -Force
              Write-Host "Renamed: $($_.Name) -> $newName"
            }
          }

          Write-Host "Stopping existing containers..."
          docker-compose down
          
          Write-Host "Starting containers..."
          # --env-file을 명시하여 모든 변수 주입
          docker-compose --env-file .env up -d --build
          
          Write-Host "Current Container Status:"
          docker ps -a
