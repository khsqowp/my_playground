name: Deploy to Windows Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Run Docker Containers
        shell: powershell
        env:
          DOCKER_HOST: tcp://localhost:2375
        run: |
          Write-Host "1. Loading secrets from C:\actions-runner\.env into shell environment..."
          $masterEnv = "C:\actions-runner\.env"
          if (Test-Path $masterEnv) {
            Get-Content $masterEnv | ForEach-Object {
              if ($_ -match '^([^#\s][^=]*)=(.*)$') {
                $key = $Matches[1].Trim()
                $val = $Matches[2].Trim().Trim('"').Trim("'")
                
                # 공백 제거 및 환경 변수 등록
                if ($key -eq "DATABASE_URL") { $val = $val.Replace(" ", "") }
                
                # 현재 세션에 환경 변수 강제 등록 (docker-compose가 읽을 수 있도록)
                Set-Content -Path "Env:\$key" -Value $val
                Write-Host "Successfully exported $key to shell."
              }
            }
          } else {
            Write-Host "ERROR: C:\actions-runner\.env not found!"
            exit 1
          }

          Write-Host "2. Deploying with Docker Compose..."
          docker-compose down
          
          # 환경 변수가 로드된 상태에서 실행
          docker-compose up -d --build
          
          Write-Host "Current Container Status:"
          docker ps -a
